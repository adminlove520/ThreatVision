name: Daily Security Monitor

on:
  schedule:
    # Run at 00:00 UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      enable_blog_publish:
        description: 'Enable blog publishing'
        required: false
        default: 'false'
        type: string
      ai_provider:
        description: 'AI provider (gemini or openai)'
        required: false
        default: 'gemini'
        type: string
      gemini_model:
        description: 'Gemini model name'
        required: false
        default: 'gemini-2.5-flash'
        type: string

permissions:
  # 确保GITHUB_TOKEN有创建Release的权限
  contents: write
  # 确保GITHUB_TOKEN有触发workflow的权限
  actions: write

jobs:
  monitor-and-report:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:6.0
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run Monitor and Generate Report
      env:
        # 优先使用GitHub Actions自动生成的GITHUB_TOKEN，提高安全性
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # 保留GITHUB_TOKENS作为备选，确保向后兼容
        GITHUB_TOKENS: ${{ secrets.GITHUB_TOKENS }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        DINGTALK_TOKEN: ${{ secrets.DINGTALK_TOKEN }}
        DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        BLOG_API_URL: ${{ secrets.BLOG_API_URL }}
        BLOG_TOKEN: ${{ secrets.BLOG_TOKEN }}
        ENABLE_BLOG_PUBLISH: ${{ github.event.inputs.enable_blog_publish || 'false' }}
        AI_PROVIDER: ${{ github.event.inputs.ai_provider || 'gemini' }}
        GEMINI_MODEL: ${{ github.event.inputs.gemini_model || 'gemini-2.5-flash' }}
        REDIS_ENABLED: true
      run: |
        python main.py --once

    - name: Upload Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: daily-report
        path: data/

    - name: Trigger UI Deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Trigger UI deployment workflow
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy_ui.yml',
            ref: 'main'
          });
          console.log('Triggered UI deployment workflow')
